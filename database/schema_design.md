# üóÑÔ∏è Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà ÏÑ§Í≥Ñ Î¨∏ÏÑú

## üìã Í∞úÏöî

Kiko ÏùºÎ≥∏Ïñ¥ ÎùºÎîîÏò§ ÌïôÏäµ ÌîåÎû´ÌèºÏùò PostgreSQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà ÏÑ§Í≥ÑÏïàÏûÖÎãàÎã§.

- **DBMS**: PostgreSQL 15 (Supabase)
- **Î≥¥Ïïà**: Row-Level Security (RLS) Ï†ÅÏö©
- **Ïù∏Ï¶ù**: Supabase Auth Ïó∞Îèô

## üéØ Îç∞Ïù¥ÌÑ∞ Î™®Îç∏ ÏöîÍµ¨ÏÇ¨Ìï≠

### ÌïµÏã¨ Í∏∞Îä•Î≥Ñ Îç∞Ïù¥ÌÑ∞ ÏöîÍµ¨ÏÇ¨Ìï≠

1. **ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨**: ÌîÑÎ°úÌïÑ, ÏÑ§Ï†ï, ÌïôÏäµ ÌÜµÍ≥Ñ
2. **Ïä§ÌÅ¨Î¶ΩÌä∏ Í¥ÄÎ¶¨**: ÎùºÎîîÏò§/ÌåüÏ∫êÏä§Ìä∏ ÏΩòÌÖêÏ∏†, Î¨∏Ïû• Îã®ÏúÑ Î∂ÑÌï†
3. **Îã®Ïñ¥Ïû• ÏãúÏä§ÌÖú**: Í∞úÏù∏ Îã®Ïñ¥ Ï†ÄÏû•, Î≥µÏäµ Ïä§ÏºÄÏ§ÑÎßÅ
4. **ÌïôÏäµ ÏßÑÌñâÎ•†**: Ïû¨ÏÉù ÏúÑÏπò, ÏôÑÎ£å Î¨∏Ïû• Ï∂îÏ†Å
5. **Î∂ÅÎßàÌÅ¨ ÏãúÏä§ÌÖú**: Ïä§ÌÅ¨Î¶ΩÌä∏/Î¨∏Ïû•/Îã®Ïñ¥ Ï†ÄÏû•

## üìä ERD (Entity Relationship Diagram)

```mermaid
erDiagram
    users ||--o{ user_scripts_progress : "has"
    users ||--o{ user_words : "owns"
    users ||--o{ bookmarks : "creates"

    scripts ||--o{ sentences : "contains"
    scripts ||--o{ user_scripts_progress : "tracked_in"
    scripts ||--o{ bookmarks : "bookmarked_as"

    words ||--o{ user_words : "learned_as"
    words ||--o{ bookmarks : "bookmarked_as"

    sentences ||--o{ bookmarks : "bookmarked_as"

    users {
        uuid id PK
        string email
        string name
        string japanese_level
        jsonb preferences
        timestamp created_at
        timestamp updated_at
        timestamp last_login
    }

    scripts {
        uuid id PK
        string title
        text description
        string audio_url
        string thumbnail_url
        integer duration
        string difficulty_level
        string category
        string language
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }

    sentences {
        uuid id PK
        uuid script_id FK
        text text
        text reading
        text translation
        float start_time
        float end_time
        string difficulty_level
        integer order_index
        timestamp created_at
    }

    words {
        uuid id PK
        string text
        string reading
        string meaning
        string part_of_speech
        string difficulty_level
        text example_sentence
        text example_translation
        string audio_url
        jsonb metadata
        timestamp created_at
        timestamp updated_at
    }

    user_words {
        uuid id PK
        uuid user_id FK
        uuid word_id FK
        integer mastery_level
        integer review_count
        string[] tags
        text notes
        timestamp added_at
        timestamp last_reviewed
        timestamp next_review
    }

    user_scripts_progress {
        uuid id PK
        uuid user_id FK
        uuid script_id FK
        float current_time
        string[] completed_sentences
        boolean completed
        timestamp last_played
        timestamp created_at
        timestamp updated_at
    }

    bookmarks {
        uuid id PK
        uuid user_id FK
        string bookmark_type
        uuid target_id FK
        text notes
        timestamp created_at
    }
```

## üèóÔ∏è ÌÖåÏù¥Î∏î ÏÉÅÏÑ∏ ÏÑ§Í≥Ñ

### 1. users ÌÖåÏù¥Î∏î

ÏÇ¨Ïö©Ïûê Í∏∞Î≥∏ Ï†ïÎ≥¥ Î∞è ÏÑ§Ï†ïÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    japanese_level VARCHAR(20) DEFAULT 'beginner' CHECK (japanese_level IN ('beginner', 'intermediate', 'advanced')),
    preferences JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login TIMESTAMP WITH TIME ZONE
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_japanese_level ON users(japanese_level);
CREATE INDEX idx_users_last_login ON users(last_login);
```

**preferences JSONB Ïä§ÌÇ§Îßà:**

```json
{
  "theme": "light|dark",
  "font_size": "small|medium|large",
  "auto_play": boolean,
  "repeat_mode": "none|sentence|word",
  "daily_goal_minutes": integer,
  "notifications": {
    "email": boolean,
    "web_push": boolean
  }
}
```

### 2. scripts ÌÖåÏù¥Î∏î

ÎùºÎîîÏò§/ÌåüÏ∫êÏä§Ìä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE scripts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    audio_url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    duration INTEGER NOT NULL, -- Ï¥ù Ïû¨ÏÉù ÏãúÍ∞Ñ (Ï¥à)
    difficulty_level VARCHAR(20) DEFAULT 'beginner' CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced')),
    category VARCHAR(50) NOT NULL, -- news, anime, podcast, drama, etc.
    language VARCHAR(10) DEFAULT 'japanese',
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_scripts_category ON scripts(category);
CREATE INDEX idx_scripts_difficulty ON scripts(difficulty_level);
CREATE INDEX idx_scripts_created_at ON scripts(created_at DESC);
CREATE INDEX idx_scripts_duration ON scripts(duration);
```

**metadata JSONB Ïä§ÌÇ§Îßà:**

```json
{
  "source": "NHK|„Ç¢„Éã„É°|„Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà",
  "tags": ["string"],
  "total_sentences": integer,
  "avg_sentence_length": float,
  "vocabulary_level": "N5|N4|N3|N2|N1"
}
```

### 3. sentences ÌÖåÏù¥Î∏î

Ïä§ÌÅ¨Î¶ΩÌä∏Ïùò Í∞úÎ≥Ñ Î¨∏Ïû•Í≥º ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE sentences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    script_id UUID NOT NULL REFERENCES scripts(id) ON DELETE CASCADE,
    text TEXT NOT NULL,
    reading TEXT, -- ÌõÑÎ¶¨Í∞ÄÎÇò
    translation TEXT NOT NULL,
    start_time FLOAT NOT NULL, -- ÏãúÏûë ÏãúÍ∞Ñ (Ï¥à)
    end_time FLOAT NOT NULL,   -- Ï¢ÖÎ£å ÏãúÍ∞Ñ (Ï¥à)
    difficulty_level VARCHAR(20) DEFAULT 'beginner' CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced')),
    order_index INTEGER NOT NULL, -- Î¨∏Ïû• ÏàúÏÑú
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Ï†úÏïΩÏ°∞Í±¥
    CONSTRAINT valid_time_range CHECK (end_time > start_time),
    CONSTRAINT valid_order_index CHECK (order_index >= 0)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_sentences_script_id ON sentences(script_id);
CREATE INDEX idx_sentences_order ON sentences(script_id, order_index);
CREATE INDEX idx_sentences_time_range ON sentences(script_id, start_time, end_time);
CREATE INDEX idx_sentences_difficulty ON sentences(difficulty_level);

-- Î≥µÌï© Ïù∏Îç±Ïä§ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
CREATE INDEX idx_sentences_script_time ON sentences(script_id, start_time);
```

### 4. words ÌÖåÏù¥Î∏î

ÏùºÎ≥∏Ïñ¥ Îã®Ïñ¥ ÏÇ¨Ï†Ñ Ï†ïÎ≥¥Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE words (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    text VARCHAR(100) NOT NULL,
    reading VARCHAR(200), -- ÌûàÎùºÍ∞ÄÎÇò ÏùΩÍ∏∞
    meaning TEXT NOT NULL,
    part_of_speech VARCHAR(50) NOT NULL, -- Î™ÖÏÇ¨, ÎèôÏÇ¨, ÌòïÏö©ÏÇ¨ Îì±
    difficulty_level VARCHAR(20) DEFAULT 'beginner' CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced')),
    example_sentence TEXT,
    example_translation TEXT,
    audio_url VARCHAR(500),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Ïú†ÎãàÌÅ¨ Ï†úÏïΩÏ°∞Í±¥
    UNIQUE(text, reading, meaning)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_words_text ON words(text);
CREATE INDEX idx_words_reading ON words(reading);
CREATE INDEX idx_words_difficulty ON words(difficulty_level);
CREATE INDEX idx_words_part_of_speech ON words(part_of_speech);

-- Ï†ÑÎ¨∏ Í≤ÄÏÉâÏùÑ ÏúÑÌïú Ïù∏Îç±Ïä§
CREATE INDEX idx_words_text_search ON words USING gin(to_tsvector('japanese', text || ' ' || reading || ' ' || meaning));
```

**metadata JSONB Ïä§ÌÇ§Îßà:**

```json
{
  "jlpt_level": "N5|N4|N3|N2|N1",
  "frequency_rank": integer,
  "conjugations": ["string"],
  "synonyms": ["string"],
  "antonyms": ["string"]
}
```

### 5. user_words ÌÖåÏù¥Î∏î

ÏÇ¨Ïö©ÏûêÎ≥Ñ Í∞úÏù∏ Îã®Ïñ¥Ïû•ÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE user_words (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    word_id UUID NOT NULL REFERENCES words(id) ON DELETE CASCADE,
    mastery_level INTEGER DEFAULT 0 CHECK (mastery_level >= 0 AND mastery_level <= 5),
    review_count INTEGER DEFAULT 0,
    tags TEXT[] DEFAULT '{}',
    notes TEXT,
    added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_reviewed TIMESTAMP WITH TIME ZONE,
    next_review TIMESTAMP WITH TIME ZONE,

    -- Ïú†ÎãàÌÅ¨ Ï†úÏïΩÏ°∞Í±¥
    UNIQUE(user_id, word_id)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_user_words_user_id ON user_words(user_id);
CREATE INDEX idx_user_words_mastery ON user_words(user_id, mastery_level);
CREATE INDEX idx_user_words_review_due ON user_words(user_id, next_review);
CREATE INDEX idx_user_words_tags ON user_words USING gin(tags);
CREATE INDEX idx_user_words_added_at ON user_words(user_id, added_at DESC);
```

### 6. user_scripts_progress ÌÖåÏù¥Î∏î

ÏÇ¨Ïö©ÏûêÎ≥Ñ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïû¨ÏÉù ÏßÑÌñâÎ•†ÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE user_scripts_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    script_id UUID NOT NULL REFERENCES scripts(id) ON DELETE CASCADE,
    current_time FLOAT DEFAULT 0, -- ÌòÑÏû¨ Ïû¨ÏÉù ÏúÑÏπò (Ï¥à)
    completed_sentences UUID[] DEFAULT '{}', -- ÏôÑÎ£åÌïú Î¨∏Ïû• ID Î∞∞Ïó¥
    completed BOOLEAN DEFAULT FALSE,
    last_played TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Ïú†ÎãàÌÅ¨ Ï†úÏïΩÏ°∞Í±¥
    UNIQUE(user_id, script_id),

    -- Ï†úÏïΩÏ°∞Í±¥
    CONSTRAINT valid_current_time CHECK (current_time >= 0)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_progress_user_id ON user_scripts_progress(user_id);
CREATE INDEX idx_progress_script_id ON user_scripts_progress(script_id);
CREATE INDEX idx_progress_last_played ON user_scripts_progress(user_id, last_played DESC);
CREATE INDEX idx_progress_completed ON user_scripts_progress(user_id, completed);
```

### 7. bookmarks ÌÖåÏù¥Î∏î

ÏÇ¨Ïö©ÏûêÏùò Î∂ÅÎßàÌÅ¨ (Ïä§ÌÅ¨Î¶ΩÌä∏, Î¨∏Ïû•, Îã®Ïñ¥)Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.

```sql
CREATE TABLE bookmarks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    bookmark_type VARCHAR(20) NOT NULL CHECK (bookmark_type IN ('script', 'sentence', 'word')),
    target_id UUID NOT NULL, -- scripts.id, sentences.id, words.id Ï∞∏Ï°∞
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Ïú†ÎãàÌÅ¨ Ï†úÏïΩÏ°∞Í±¥
    UNIQUE(user_id, bookmark_type, target_id)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_bookmarks_user_id ON bookmarks(user_id);
CREATE INDEX idx_bookmarks_type ON bookmarks(user_id, bookmark_type);
CREATE INDEX idx_bookmarks_created_at ON bookmarks(user_id, created_at DESC);
```

## üîí Row-Level Security (RLS) Ï†ïÏ±Ö

### RLS ÌôúÏÑ±Ìôî

```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_words ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_scripts_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookmarks ENABLE ROW LEVEL SECURITY;

-- Í≥µÍ∞ú ÌÖåÏù¥Î∏îÏùÄ RLS ÎπÑÌôúÏÑ±Ìôî (ÏùΩÍ∏∞ Ï†ÑÏö©)
-- scripts, sentences, words ÌÖåÏù¥Î∏îÏùÄ Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä ÏùΩÏùÑ Ïàò ÏûàÏùå
```

### ÏÇ¨Ïö©Ïûê ÌÖåÏù¥Î∏î Ï†ïÏ±Ö

```sql
-- ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò Ï†ïÎ≥¥Îßå Ï°∞Ìöå/ÏàòÏ†ï Í∞ÄÎä•
CREATE POLICY "users_own_data" ON users
    FOR ALL USING (auth.uid() = id);
```

### ÏÇ¨Ïö©Ïûê Îã®Ïñ¥Ïû• Ï†ïÏ±Ö

```sql
-- ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò Îã®Ïñ¥Ïû•Îßå Í¥ÄÎ¶¨ Í∞ÄÎä•
CREATE POLICY "user_words_own_data" ON user_words
    FOR ALL USING (auth.uid() = user_id);
```

### ÌïôÏäµ ÏßÑÌñâÎ•† Ï†ïÏ±Ö

```sql
-- ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò ÏßÑÌñâÎ•†Îßå Í¥ÄÎ¶¨ Í∞ÄÎä•
CREATE POLICY "progress_own_data" ON user_scripts_progress
    FOR ALL USING (auth.uid() = user_id);
```

### Î∂ÅÎßàÌÅ¨ Ï†ïÏ±Ö

```sql
-- ÏÇ¨Ïö©ÏûêÎäî ÏûêÏã†Ïùò Î∂ÅÎßàÌÅ¨Îßå Í¥ÄÎ¶¨ Í∞ÄÎä•
CREATE POLICY "bookmarks_own_data" ON bookmarks
    FOR ALL USING (auth.uid() = user_id);
```

### Í≥µÍ∞ú ÏΩòÌÖêÏ∏† Ï†ïÏ±Ö

```sql
-- Î™®Îì† ÏÇ¨Ïö©ÏûêÍ∞Ä Ïä§ÌÅ¨Î¶ΩÌä∏, Î¨∏Ïû•, Îã®Ïñ¥ ÏùΩÍ∏∞ Í∞ÄÎä•
CREATE POLICY "scripts_read_all" ON scripts FOR SELECT USING (true);
CREATE POLICY "sentences_read_all" ON sentences FOR SELECT USING (true);
CREATE POLICY "words_read_all" ON words FOR SELECT USING (true);
```

## ‚ö° ÏÑ±Îä• ÏµúÏ†ÅÌôî ÏÑ§Í≥Ñ

### Ï£ºÏöî ÏøºÎ¶¨ Ìå®ÌÑ¥ Î∂ÑÏÑù

1. **Ïä§ÌÅ¨Î¶ΩÌä∏ Î™©Î°ù Ï°∞Ìöå**: category, difficulty ÌïÑÌÑ∞ÎßÅ
2. **Î¨∏Ïû• ÏàúÏ∞® Ï°∞Ìöå**: script_id + order_index Ï†ïÎ†¨
3. **Îã®Ïñ¥Ïû• Ï°∞Ìöå**: user_id + mastery_level ÌïÑÌÑ∞ÎßÅ
4. **Î≥µÏäµ Îã®Ïñ¥ Ï°∞Ìöå**: user_id + next_review ÎÇ†Ïßú Î≤îÏúÑ
5. **Ïû¨ÏÉù ÏßÑÌñâÎ•† Ï°∞Ìöå**: user_id + script_id

### Î≥µÌï© Ïù∏Îç±Ïä§ Ï†ÑÎûµ

```sql
-- Ïä§ÌÅ¨Î¶ΩÌä∏ ÌïÑÌÑ∞ÎßÅ ÏµúÏ†ÅÌôî
CREATE INDEX idx_scripts_category_difficulty ON scripts(category, difficulty_level, created_at DESC);

-- Î¨∏Ïû• Ïû¨ÏÉù ÏàúÏÑú ÏµúÏ†ÅÌôî
CREATE INDEX idx_sentences_script_order ON sentences(script_id, order_index);

-- Îã®Ïñ¥Ïû• Î≥µÏäµ ÏµúÏ†ÅÌôî
CREATE INDEX idx_user_words_review_schedule ON user_words(user_id, next_review, mastery_level);

-- ÌïôÏäµ ÌÜµÍ≥Ñ ÏµúÏ†ÅÌôî
CREATE INDEX idx_progress_stats ON user_scripts_progress(user_id, completed, last_played DESC);
```

### ÌååÌã∞ÏÖîÎãù Í≥ÑÌöç (ÌôïÏû• Ïãú)

```sql
-- ÏÇ¨Ïö©Îüâ Ï¶ùÍ∞Ä Ïãú ÏõîÎ≥Ñ ÌååÌã∞ÏÖîÎãù Í≥†Î†§
-- user_scripts_progress ÌÖåÏù¥Î∏îÏùÑ last_played Í∏∞Ï§ÄÏúºÎ°ú ÌååÌã∞ÏÖîÎãù
-- Ïòà: progress_2024_01, progress_2024_02, ...
```

## üìà Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ Ï†ïÏ±Ö

### ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ Ìä∏Î¶¨Í±∞

```sql
-- updated_at ÏûêÎèô Í∞±Ïã†
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_scripts_updated_at BEFORE UPDATE ON scripts
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_words_updated_at BEFORE UPDATE ON words
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_progress_updated_at BEFORE UPDATE ON user_scripts_progress
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### Îç∞Ïù¥ÌÑ∞ Ï†ïÌï©ÏÑ± Í≤ÄÏ¶ù

```sql
-- Î¨∏Ïû• ÏãúÍ∞Ñ Î≤îÏúÑ Í≤ÄÏ¶ù
CREATE OR REPLACE FUNCTION validate_sentence_time_range()
RETURNS TRIGGER AS $$
BEGIN
    -- Ïä§ÌÅ¨Î¶ΩÌä∏ Ï¥ù Ïû¨ÏÉù ÏãúÍ∞Ñ ÎÇ¥Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
    IF EXISTS (
        SELECT 1 FROM scripts
        WHERE id = NEW.script_id
        AND NEW.end_time > duration
    ) THEN
        RAISE EXCEPTION 'Sentence end time exceeds script duration';
    END IF;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER validate_sentence_time BEFORE INSERT OR UPDATE ON sentences
    FOR EACH ROW EXECUTE FUNCTION validate_sentence_time_range();
```

## üß™ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Í≥ÑÌöç

### Ï¥àÍ∏∞ ÏãúÎìú Îç∞Ïù¥ÌÑ∞

1. **ÏÉòÌîå Ïä§ÌÅ¨Î¶ΩÌä∏**: 3-5Í∞ú (Îâ¥Ïä§, Ïï†ÎãàÎ©îÏù¥ÏÖò, ÌåüÏ∫êÏä§Ìä∏)
2. **Í∏∞Î≥∏ Îã®Ïñ¥**: 1000Í∞ú (JLPT N5-N4 ÏàòÏ§Ä)
3. **ÌÖåÏä§Ìä∏ ÏÇ¨Ïö©Ïûê**: Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö© Í≥ÑÏ†ï

### ÏÑ±Îä• ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞

- **Ïä§ÌÅ¨Î¶ΩÌä∏**: 100Í∞ú
- **Î¨∏Ïû•**: 10,000Í∞ú
- **Îã®Ïñ¥**: 50,000Í∞ú
- **ÏÇ¨Ïö©Ïûê**: 1,000Î™Ö
- **ÌïôÏäµ Îç∞Ïù¥ÌÑ∞**: 10,000Í∞ú

## üìã ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï†ÑÎûµ

### 1. Í∏∞Î≥∏ Ïä§ÌÇ§Îßà ÏÉùÏÑ±

```sql
-- 01_create_base_tables.sql
-- Í∏∞Î≥∏ ÌÖåÏù¥Î∏î Íµ¨Ï°∞ ÏÉùÏÑ±
```

### 2. Ïù∏Îç±Ïä§ Î∞è Ï†úÏïΩÏ°∞Í±¥

```sql
-- 02_create_indexes.sql
-- ÏÑ±Îä• ÏµúÏ†ÅÌôî Ïù∏Îç±Ïä§ ÏÉùÏÑ±
```

### 3. RLS Ï†ïÏ±Ö Ï†ÅÏö©

```sql
-- 03_setup_rls.sql
-- Row-Level Security Ï†ïÏ±Ö ÏÑ§Ï†ï
```

### 4. Ìä∏Î¶¨Í±∞ Î∞è Ìï®Ïàò

```sql
-- 04_create_triggers.sql
-- ÏûêÎèôÌôî Ìä∏Î¶¨Í±∞ Î∞è Í≤ÄÏ¶ù Ìï®Ïàò
```

### 5. Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞

```sql
-- 05_seed_data.sql
-- Í∏∞Î≥∏ Îã®Ïñ¥, ÏÉòÌîå Ïä§ÌÅ¨Î¶ΩÌä∏ Îç∞Ïù¥ÌÑ∞
```

## ‚úÖ Í≤ÄÏ¶ù Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

- [ ] Î™®Îì† ÌÖåÏù¥Î∏î ÏÉùÏÑ± Î∞è Í¥ÄÍ≥Ñ ÏÑ§Ï†ï ÏôÑÎ£å
- [ ] Ïù∏Îç±Ïä§ ÏÑ±Îä• ÏµúÏ†ÅÌôî Ï†ÅÏö©
- [ ] RLS Ï†ïÏ±Ö Ïò¨Î∞îÎ•∏ ÎèôÏûë ÌôïÏù∏
- [ ] Ìä∏Î¶¨Í±∞ Î∞è Ï†úÏïΩÏ°∞Í±¥ ÌÖåÏä§Ìä∏
- [ ] Î∞±ÏóîÎìú Pydantic Î™®Îç∏Í≥º ÏùºÏπòÏÑ± Í≤ÄÏ¶ù
- [ ] ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÏÇΩÏûÖ Î∞è ÏøºÎ¶¨ ÌÖåÏä§Ìä∏
- [ ] API ÏóîÎìúÌè¨Ïù∏Ìä∏ Ïó∞Îèô ÌÖåÏä§Ìä∏

---

**ÏûëÏÑ±Ïùº**: 2024-01-XX  
**ÏûëÏÑ±Ïûê**: Claude AI  
**Í≤ÄÌÜ†Ïûê**: [Í∞úÎ∞úÌåÄ]  
**ÏäπÏù∏Ïûê**: [ÌîÑÎ°úÏ†ùÌä∏ Îß§ÎãàÏ†Ä]
